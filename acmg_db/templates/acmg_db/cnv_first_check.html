{% extends 'acmg_db/cnv_base.html' %}
{% load static %}
{% block content %}
{% load crispy_forms_tags %}


<style>
.evidence_images {
  border-radius: 5px;
  cursor: pointer;
  transition: 0.3s;
}

.evidence_images:hover {opacity: 0.7;}

</style>

<br>

<br>
	<p> 
	<a class="btn btn-success btn-sm" href="{% url 'pending_classifications' %}">RETURN TO MAIN ACMG VARIANT DB</a>
	</p>
<br>

<br>
<h4>CNV First Check</h4>
<br>

<!-- BOX TO SHOW ERRORS -->
{% if warn %}
  {% for w in warn %}
    <div class="alert alert-danger" role="alert">
	    Error: {{ w }}
	  </div>
  {% endfor %}
{% endif %}

<!-- CNV SUMMARY BOX -->
<div>
	<table class="table table-bordered">
		
		<thead>
			<tr>
				<td style="width: 10.00%">Worksheet</td>
				<td style="width: 10.00%">Sample</td>
				<td style="width: 20.00%">CNV</td>
				<td style="width: 40.00%">Current Classification</td>
				<td style="width: 20.00%">Status</td>
			</tr>
		</thead>
		
		<tbody>
			<tr>
				<td>{{ cnv.sample.worklist }}</td>
				<td>{{ cnv.sample.sample_name }}</td>
				<td>{{ cnv.cnv}} <br> 
				{% if cnv.sample.genome == 'GRCh37' %}
					<span class="badge badge-info badge-pill">{{ cnv.sample.genome }}</td>
				{% elif classification.genome == 'GRCh38' %}
					<span class="badge badge-success badge-pill">{{ cnv.sample.genome }}</td>
					{% endif %}
				<td>CLASSIFICATION
					<!---
					<div id="class_box">
					{% if 'Pathogenic' in result %}
						<button type="button" class="btn btn-danger" style="width: 100%;">{{result}}</span></button>
					{% elif 'Benign' in result %}
						<button type="button" class="btn btn-info" style="width: 100%;">{{result}}</button>
					{% elif 'VUS' in result %}
						<button type="button" class="btn btn-warning" style="width: 100%;">{{result}}</button>
					{% elif 'Artefact' in result %}
						<button type="button" class="btn btn-secondary" style="width: 100%;">{{result}}</button>
					{% elif 'Contradictory' in result %}
                        <button type="button" class="btn btn-primary" style="width: 100%;">{{result}}</button>
					{% else %}
						<button type="button" class="btn btn-light" style="width: 100%;">{{result}}</button>
					{% endif %}
					</div>
					-->
				</td>
				<td>CLASSIFICATION DISPLAY STATUS</td>
			</tr>
		</tbody>

	</table>
	<hr>
</div>

<!------------------------------------- END OF HTML ------------------------------------->


<script>
$(document).ready(function(){

</script>



<!-- JAVASCRIPT -->
<script>
$(document).ready(function(){

	var canvas_entered =false;

	$(function () {
		$('[data-toggle="tooltip"]').tooltip()
	})

	// Inititialise DataTable
	var table = $('#acmg_question_table').DataTable({
		"paging":   false,
		"ordering": false,
		"info":     false,
		"searching": false,
		"rowGroup": {
        dataSrc: 1
    }
		});

	//Colour row when clicked
	$(".answer-selected").change(function(){
		// what is the value of the drop down
		value = $(this).val()
		// if true set the value to red or green depending on whether it is a P or B question
		if (value == 'True'){
			question = $(this).parent().siblings('td.question').text();
			path = question.trim().substring(0, 1);
			if (path == 'P'){
				$(this).parent().parent().addClass("table-danger")
			} else {
				$(this).parent().parent().addClass("table-info")
			}
			
		} else {
			// remove classes when moving to false
			$(this).parent().parent().removeClass("table-danger");
			$(this).parent().parent().removeClass("table-info");
		}
	});


	// When we destroy a comment
	$('body').on('click', '.comment_destroy', function(e){

		var r = confirm("Are you sure you want to delete this comment?");

		if ( r ==true ){


		comment_pk = this.id;

		console.log(comment_pk);

		var formData = new FormData();
		formData.append('csrfmiddlewaretoken',document.getElementsByName('csrfmiddlewaretoken')[0].value ); //add csfr token
		formData.append('comment_pk', comment_pk); //add comment primary key
		formData.append('classification_pk', "{{classification.pk}}")

		$.ajax({
			url: '/ajax/delete_comment/',
			type: 'POST',
			data: formData,
			contentType: false, // NEEDED, DON'T OMIT THIS (requires jQuery 1.6+)
			processData: false, // NEEDED, DON'T OMIT THIS
			success: function(data) {
			$("#comment_box").html(data);
			},
			failure: function(data) {
			alert('Got an error');
			}
			});
	}

	else {

		console.log('didnt bother');

	}


	});



	$("#genuine-artefact-form").on("submit", function () {
    $(this).find(":submit").prop("disabled", true);
	});



	
	// When we click the submit ACMG
	$(".acmg_submit").click(function(){

		// construct a dictionary of objects to submit to server
		var rows = $("#acmg_question_table").children('tbody').children();
		var classification_dict = {}

		// Loop though each row
		for (var i =0; i<rows.length; i++){

				// skip group rows in table
				if ($(rows[i]).hasClass('dtrg-group') == false){

				var pk = $(rows[i]).children('td.answer_pk').text();
				// allow either select drop downs or plain text
				var type = $(rows[i]).children('td.strength').children().is("select")
				if (type == true){

					var strength = $(rows[i]).children('td.strength').children().val()

				} else {

					var strength = $.trim($(rows[i]).children('td.strength').text());
				}

				var question  = $(rows[i]).children('td.question').text().trim();
				var selected = $(rows[i]).children('td.selected_first').children().val();
				var comment = $(rows[i]).children('td.comment').children().val();
				console.log(pk, question, strength, selected, comment)
				classification_dict[pk] = [question, strength, selected, comment];
			}}

		var formData = new FormData();
		formData.append('csrfmiddlewaretoken',document.getElementsByName('csrfmiddlewaretoken')[0].value );
		formData.append('classifications', JSON.stringify(classification_dict));
		formData.append('classification_pk', "{{classification.pk}}" );
		$.ajax({
			url: '/ajax/acmg_classification_first/',
			type: 'POST',
			data: formData,
			contentType: false, // NEEDED, DON'T OMIT THIS (requires jQuery 1.6+)
			processData: false, // NEEDED, DON'T OMIT THIS
			success: function(data) {
			$("#class_box").html(data);
			},
			failure: function(data) {
			alert('Got an error');
			}
			});
	});


	$('#file_upload').on('change', function() { //runs when a file is selected
		var file = this.files[0];
		$('#file_name').text(file.name + " has been selected. Click Add Comment/File to upload.");
		$('#file_name').show();
	});


	$("#comment_button").click(function(){

		var comment_text = $("#comment_text").val();
		var formData = new FormData(); //create empty form data
		formData.append('csrfmiddlewaretoken',document.getElementsByName('csrfmiddlewaretoken')[0].value ); //add csfr token
		formData.append('classification_pk', "{{classification.pk}}"); //add sample primary key
		formData.append('comment_text', comment_text); //add comment text
		var file = $('#file_upload')[0].files[0];
		var canvas = document.getElementById('my_canvas');
		var dataURL = canvas.toDataURL("image/png");
		document.getElementById('hidden_image_field').value = dataURL;
		formData.append('file', file); //add file

		if (canvas_entered ==true){
			formData.append('image_data', $("#hidden_image_field").val()); //add image file
			canvas_entered =false;
		}

		console.log(comment_text.length);

		if (comment_text == ''){

			alert('You need to enter a comment to submit.')
		} else{



		$.ajax({
			url: '/ajax/comments/',
			type: 'POST',
			data: formData,
			contentType: false, // NEEDED, DON'T OMIT THIS (requires jQuery 1.6+)
			processData: false, // NEEDED, DON'T OMIT THIS
			success: function(data) {
				$("#comment_box").html(data);
				$("#comment_text").val('');
				$('#file_name').hide();
				$('#file_upload').val('');
					var c = document.getElementById("my_canvas");
					var ctx = c.getContext("2d");
					ctx.clearRect(0, 0, canvas.width, canvas.height);
					c.width = 300;
					c.height = 300;

			},

			failure: function(data) {
				alert('Got an error');
			}
		});
		}
	});



$("#defaultCheck1").click(function() {

	if (this.checked) {
        var CLIPBOARD = new CLIPBOARD_CLASS("my_canvas", true);
		var canvas_entered =false;
    } 
});

//copy and paste from clipboard
//Taken from https://stackoverflow.com/questions/18377891/how-can-i-let-user-paste-image-data-from-the-clipboard-into-a-canvas-element-in

/**
 * image pasting into canvas
 * 
 * @param {string} canvas_id - canvas id
 * @param {boolean} autoresize - if canvas will be resized
 */
function CLIPBOARD_CLASS(canvas_id, autoresize) {
	var _self = this;
	var canvas = document.getElementById(canvas_id);
	var ctx = document.getElementById(canvas_id).getContext("2d");

	//handlers
	document.addEventListener('paste', function (e) { _self.paste_auto(e); }, false);

	//on paste
	this.paste_auto = function (e) {

		if (e.clipboardData) {
			var items = e.clipboardData.items;
			if (!items) return;
			
			//access data directly
			for (var i = 0; i < items.length; i++) {
				if (items[i].type.indexOf("image") !== -1) {
					//image
					var blob = items[i].getAsFile();
					var URLObj = window.URL || window.webkitURL;
					var source = URLObj.createObjectURL(blob);
					this.paste_createImage(source);
				}
			}
			e.preventDefault();
		}
	};
	//draw pasted image to canvas
	this.paste_createImage = function (source) {
		var pastedImage = new Image();
		canvas_entered =true;
		pastedImage.onload = function () {
			if(autoresize == true){
				//resize
				canvas.width = pastedImage.width;
				canvas.height = pastedImage.height;
			}
			else{
				//clear canvas
				ctx.clearRect(0, 0, canvas.width, canvas.height);
			}
			ctx.drawImage(pastedImage, 0, 0);
		};
		pastedImage.src = source;
	};
}



});

</script>



{% csrf_token %}
{% endblock %}
